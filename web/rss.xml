{{- $siteConf := include "site.json" | fromJson -}}
{{- $host := $siteConf.host -}}


{{- $p := dict -}}
{{- range (get $siteConf "rss-sections") -}}
    {{- $section := . -}}
    {{- $sectionTitle := $section | title -}}

    {{- $fis := listFiles (printf "%s/markdown" $section) -}}
    {{- range $fis -}}
        {{- $_ := set $p . (printf "/%s/markdown/%s" $section .) -}}
    {{- end -}}
{{- end -}}

{{- $pKeys := keys $p | sortAlpha | reverse -}}

{{- $parsedPages := list -}}
{{- range $pKeys -}}
    {{- $filename := get $p . -}}
    {{- $is_index := (contains "index.md" .) -}}
    {{- if not $is_index -}}
        {{- $section := (mustRegexSplit "/" $filename 3 | rest | first) -}}
        {{- $parsed := include (get $p .) | splitFrontMatter -}}
        {{- if not (default false $parsed.Meta.draft) -}}
            {{- $_ := set $parsed.Meta "filename" $filename -}}
            {{- $_ := set $parsed.Meta "section" $section -}}
            {{- $parsedPages = append $parsedPages $parsed -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>{{-  $siteConf.title | toJson -}}</title>
        <link>{{- printf "%s/rss.xml" $host -}}</link>
        <description>{{- printf "Recent content for %s" $siteConf.title -}}</description>
        <docs>https://cyber.harvard.edu/rss/rss.html</docs>
        <ttl>1440</ttl>
        <pubDate>{{- ($parsedPages | first).Meta.createdAt.Format "02 Mar 2006 15:04:05 -0700" -}}</pubDate>
        <atom:link href="{{ printf "%s/rss.xml" $host }}" rel="self" type="application/rss+xml" />



        {{- range $parsedPages -}}
        {{- $link := printf "%s/%s/markdown/%s.html" $host .Meta.section ((mustRegexSplit "_" .Meta.filename 2 | last) | trimSuffix ".md") }}
        <item>
            <title>{{ .Meta.title | replace "&" "&amp;" | replace "<" "&lt;" | replace ">" "&gt;" | replace "'" "&apos;" | replace "\"" "&quot;" }}</title>
            <link>{{ $link }}</link>
            <pubDate>{{ .Meta.createdAt.Format "02 Mar 2006 15:04:05 -0700" }}</pubDate>
            {{ with .Meta.author -}}<author>{{- . -}}</author>{{- end -}}
            <guid>{{ $link }}</guid>
            {{ with .Meta.description -}}<description>{{- . | replace "&" "&amp;" | replace "<" "&lt;" | replace ">" "&gt;" | replace "'" "&apos;" | replace "\"" "&quot;" }}</description>{{- end }}
            <category>{{- .Meta.section -}}</category>
        </item>
        {{- end }}
    </channel>
</rss>
